<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NeuroGuard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
        rel="stylesheet"
    />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
        }
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #1f1f1f;
            border-bottom: 1px solid #333;
            z-index: 50;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e0e0e0;
        }
        .navbar-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .connection-button {
            padding: 0.5rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .status-disconnected {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }
        .status-disconnected:hover {
            background-color: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
        }
        .status-connected {
            background-color: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3);
        }
        .status-connected:hover {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }
        .status-connecting {
            background-color: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border-color: rgba(59, 130, 246, 0.3);
            cursor: not-allowed;
        }
        .pause-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .pause-active {
            background-color: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border-color: rgba(251, 191, 36, 0.3);
        }
        .pause-active:hover {
            background-color: rgba(251, 191, 36, 0.3);
            border-color: rgba(251, 191, 36, 0.5);
        }
        .pause-inactive {
            background-color: rgba(147, 51, 234, 0.2);
            color: #a855f7;
            border-color: rgba(147, 51, 234, 0.3);
        }
        .pause-inactive:hover {
            background-color: rgba(147, 51, 234, 0.3);
            border-color: rgba(147, 51, 234, 0.5);
        }
        .main-content {
            margin-top: 5rem;
            padding: 2rem;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #1f1f1f;
            margin: 10% auto;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 15px rgba(0,0,0,0.3);
            max-width: 600px;
            animation: fadeIn 0.3s ease-in-out;
            color: #e0e0e0;
        }
        .close-button {
            color: #888;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover, .close-button:focus {
            color: #ccc;
            text-decoration: none;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .live-feed-box {
            background-color: #2c2c2c;
            color: #a0a0a0;
            font-family: 'Courier New', Courier, monospace;
            height: 200px;
            overflow-y: scroll;
        }
        .hidden { display: none; }
        .risk-level {
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            font-size: 0.75rem;
        }
        .risk-low { background-color: #16a34a; color: white; }
        .risk-moderate { background-color: #ca8a04; color: white; }
        .risk-high { background-color: #c2410c; color: white; }
        .risk-severe { background-color: #991b1b; color: white; }

        .chart-container {
            height: 20rem;
            position: relative;
        }
        canvas { display: block; }
        
        .fullscreen-modal {
            display: none;
            position: fixed;
            z-index: 200;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: #121212;
        }
        
        .fullscreen-chart-container {
            width: 100%;
            height: calc(100% - 60px);
            padding: 20px;
            box-sizing: border-box;
        }
        
        .fullscreen-header {
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background-color: #1f1f1f;
            border-bottom: 1px solid #333;
        }
        
        .fullscreen-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e0e0e0;
        }
        
        .fullscreen-controls {
            display: flex;
            gap: 10px;
        }
        
        .fullscreen-btn {
            padding: 8px 16px;
            background-color: #2c2c2c;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .fullscreen-btn:hover {
            background-color: #3c3c3c;
        }
        
        .chart-wrapper {
            position: relative;
            user-select: none;
        }
        
        .chart-hint {
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 0.7rem;
            color: rgba(160, 160, 160, 0.5);
            pointer-events: none;
        }
        
        .risk-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        @media (max-width: 768px) {
            .risk-grid { grid-template-columns: 1fr; }
        }
        
        .risk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .shortcuts-grid {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background-color: #2c2c2c;
            border-radius: 0.5rem;
            border: 1px solid #444;
        }
        
        .shortcut-key {
            font-family: 'Courier New', monospace;
            background-color: #1a1a1a;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #555;
            color: #3b82f6;
            font-weight: 600;
        }
        
        .shortcut-description {
            color: #e0e0e0;
        }
        
        .help-button {
            background-color: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .help-button:hover {
            background-color: rgba(59, 130, 246, 0.3);
            border-color: rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">üß† NeuroGuard</div>
        <div class="navbar-controls">
            <button id="connectButton" class="connection-button status-disconnected">
                <span class="status-icon">‚ö™</span>
                <span class="status-text">Disconnected</span>
            </button>
            <button id="pauseButton" class="pause-button pause-inactive hidden">
                <span class="pause-icon">‚è∏Ô∏è</span>
                <span class="pause-text">Pause</span>
            </button>
            <button id="helpButton" class="help-button">
                <span style="font-size: 1.2rem;">‚å®Ô∏è</span> Shortcuts
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content max-w-7xl mx-auto">
        <!-- Head Impact Risk Dashboard -->
        <div id="risk-dashboard" class="bg-gray-800 p-4 rounded-xl shadow-xl mb-6">
            <div class="risk-header">
                <h2 class="text-lg font-semibold text-gray-200">Headband Impact Risk Assessment</h2>
                <button id="clearHistoryButton" class="bg-red-600 hover:bg-red-700 text-white font-medium py-1 px-4 rounded-lg text-sm transition duration-300">
                    Clear History
                </button>
            </div>
            <div class="risk-grid mb-4">
                <div class="bg-gray-700 p-3 rounded-lg">
                    <h3 class="text-sm font-medium text-gray-400 mb-1">NRS Score</h3>
                    <div class="flex items-baseline gap-2">
                        <p id="nrs-score" class="text-2xl font-bold text-gray-100">0.0</p>
                        <p id="nrs-level" class="risk-level risk-low">Low Risk</p>
                    </div>
                </div>
                <div class="bg-gray-700 p-3 rounded-lg">
                    <h3 class="text-sm font-medium text-gray-400 mb-1">Acute (AWE)</h3>
                    <p id="awe-score" class="text-2xl font-bold text-yellow-300">0.0</p>
                </div>
                <div class="bg-gray-700 p-3 rounded-lg">
                    <h3 class="text-sm font-medium text-gray-400 mb-1">Chronic (CLI)</h3>
                    <p id="cli-score" class="text-2xl font-bold text-blue-300">0.0</p>
                </div>
            </div>
            <div class="h-48 chart-wrapper">
                <canvas id="nrsChartCanvas"></canvas>
                <div class="chart-hint">Hold to reset ‚Ä¢ Double-click to expand</div>
            </div>
        </div>

        <!-- Live Graphs -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-6">
            <div class="bg-gray-800 p-6 rounded-xl shadow-xl">
                <h2 class="text-lg font-semibold text-gray-200 mb-4">Accelerometer</h2>
                <div class="relative h-80 chart-wrapper">
                    <canvas id="accelChartCanvas"></canvas>
                    <div class="chart-hint">Hold to reset ‚Ä¢ Double-click to expand</div>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-xl">
                <h2 class="text-lg font-semibold text-gray-200 mb-4">Gyroscope</h2>
                <div class="relative h-80 chart-wrapper">
                    <canvas id="gyroChartCanvas"></canvas>
                    <div class="chart-hint">Hold to reset ‚Ä¢ Double-click to expand</div>
                </div>
            </div>
        </div>

        <!-- Debug Panel -->
        <details class="bg-gray-800 p-6 rounded-xl shadow-xl">
            <summary class="text-lg font-semibold text-gray-200 cursor-pointer select-none">
                Debug Information
            </summary>
            <div class="mt-4 flex flex-col gap-6">
                <div id="data-container">
                    <div class="bg-gray-700 p-6 rounded-xl shadow-inner">
                        <h2 class="text-lg font-semibold text-gray-200 mb-2">Sensor Data</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h3 class="text-md font-semibold text-gray-400">Acceleration (m/s¬≤)</h3>
                                <div class="space-y-1 text-gray-300 font-medium text-sm">
                                    <p>X: <span id="accelX" class="font-mono text-gray-100">--</span></p>
                                    <p>Y: <span id="accelY" class="font-mono text-gray-100">--</span></p>
                                    <p>Z: <span id="accelZ" class="font-mono text-gray-100">--</span></p>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-md font-semibold text-gray-400">Gyro (rad/s)</h3>
                                <div class="space-y-1 text-gray-300 font-medium text-sm">
                                    <p>X: <span id="gyroX" class="font-mono text-gray-100">--</span></p>
                                    <p>Y: <span id="gyroY" class="font-mono text-gray-100">--</span></p>
                                    <p>Z: <span id="gyroZ" class="font-mono text-gray-100">--</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-700 p-6 rounded-xl shadow-xl">
                    <h2 class="text-lg font-semibold text-gray-200 mb-2">Live Data Feed (JSON)</h2>
                    <pre id="live-feed" class="live-feed-box p-4 rounded-xl text-xs overflow-auto"></pre>
                </div>
            </div>
        </details>

        <!-- Alert Modal -->
        <div id="alert-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="document.getElementById('alert-modal').style.display='none'">&times;</span>
                <div id="alert-message" class="text-gray-300 whitespace-pre-line"></div>
            </div>
        </div>
        
        <!-- Shortcuts Modal -->
        <div id="shortcuts-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="document.getElementById('shortcuts-modal').style.display='none'">&times;</span>
                <h3 class="text-xl font-bold mb-2">‚å®Ô∏è Keyboard Shortcuts & Gestures</h3>
                <div class="shortcuts-grid">
                    <h4 class="text-lg font-semibold text-gray-300 mt-2">Chart Controls</h4>
                    <div class="shortcut-item"><span class="shortcut-description">Reset chart zoom</span><span class="shortcut-key">Hold (0.5s)</span></div>
                    <div class="shortcut-item"><span class="shortcut-description">Open fullscreen view</span><span class="shortcut-key">Double-click</span></div>
                    <div class="shortcut-item"><span class="shortcut-description">Zoom in/out</span><span class="shortcut-key">Scroll wheel</span></div>
                    <div class="shortcut-item"><span class="shortcut-description">Pan chart</span><span class="shortcut-key">Click & drag</span></div>
                    <h4 class="text-lg font-semibold text-gray-300 mt-4">Keyboard Shortcuts</h4>
                    <div class="shortcut-item"><span class="shortcut-description">Close fullscreen/modals</span><span class="shortcut-key">ESC</span></div>
                    <div class="shortcut-item"><span class="shortcut-description">Connect/Disconnect BLE</span><span class="shortcut-key">C</span></div>
                    <div class="shortcut-item"><span class="shortcut-description">Pause/Resume (zeros on resume)</span><span class="shortcut-key">P</span></div>
                    <div class="shortcut-item"><span class="shortcut-description">Clear impact history</span><span class="shortcut-key">Delete</span></div>
                    <div class="shortcut-item"><span class="shortcut-description">Toggle debug panel</span><span class="shortcut-key">D</span></div>
                    <div class="shortcut-item"><span class="shortcut-description">Show shortcuts</span><span class="shortcut-key">?</span></div>
                    <h4 class="text-lg font-semibold text-gray-300 mt-4">Connection Status</h4>
                    <div class="shortcut-item"><span class="shortcut-description">Click button to connect</span><span class="shortcut-key">‚ö™ Red</span></div>
                    <div class="shortcut-item"><span class="shortcut-description">Click button to disconnect</span><span class="shortcut-key">üü¢ Green</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Fullscreen Modal -->
    <div id="fullscreen-modal" class="fullscreen-modal">
        <div class="fullscreen-header">
            <div id="fullscreen-title" class="fullscreen-title">Chart</div>
            <div class="fullscreen-controls">
                <button class="fullscreen-btn" onclick="resetZoom()">Reset Zoom</button>
                <button class="fullscreen-btn" onclick="closeFullscreen()">‚úï Close</button>
            </div>
        </div>
        <div class="fullscreen-chart-container">
            <canvas id="fullscreenChartCanvas"></canvas>
        </div>
    </div>

    <script>
        const DOM_FPS = 60;
        let lastDomFlush = 0;
        const latestDisplay = { a: {}, g: {} };
        const GYRO_MULTIPLIER = 2.5;

        let fullscreenChart = null;
        let currentFullscreenType = null;
        let nrsUpdateInterval = null;
        let lastNRSUpdate = 0;
        let connectionStartTime = 0;
        let impactDetectionDisabled = true;
        let isConnected = false;
        let isPaused = false;
        let latestSensorData = null;

        function showCustomAlert(content) {
            const modal = document.getElementById('alert-modal');
            const alertMessage = document.getElementById('alert-message');
            alertMessage.textContent = content;
            modal.style.display = 'block';
        }

        const SERVICE_UUID = "12345678-1234-1234-1234-123456789abc";
        const CHARACTERISTIC_UUID = "87654321-4321-4321-4321-cba987654321";
        const DEVICE_NAME = "ESP32_MPU6050_BLE";

        const connectButton = document.getElementById('connectButton');
        const pauseButton = document.getElementById('pauseButton');
        const clearHistoryButton = document.getElementById('clearHistoryButton');
        const helpButton = document.getElementById('helpButton');
        const liveFeed = document.getElementById('live-feed');
        const accelXEl = document.getElementById('accelX');
        const accelYEl = document.getElementById('accelY');
        const accelZEl = document.getElementById('accelZ');
        const gyroXEl = document.getElementById('gyroX');
        const gyroYEl = document.getElementById('gyroY');
        const gyroZEl = document.getElementById('gyroZ');
        const nrsScoreEl = document.getElementById('nrs-score');
        const nrsLevelEl = document.getElementById('nrs-level');
        const aweScoreEl = document.getElementById('awe-score');
        const cliScoreEl = document.getElementById('cli-score');

        let bleDevice;
        let bleCharacteristic;

        const SMOOTHING_WINDOW_SIZE = 7;
        const VISIBLE_DATA_POINTS = 400;
        const NRS_VISIBLE_POINTS = 360;
        const dataPointsPerSecond = 100;
        const Y_BUFFER_PERCENTAGE = 0.15;
        const MIN_Y_RANGE = 4;
        const NRS_UPDATE_INTERVAL = 5000;

        let accelHistory = { x: [], y: [], z: [] };
        let gyroHistory = { x: [], y: [], z: [] };

        const stillBuf = { accel: { x: [], y: [], z: [] }, gyro: { x: [], y: [], z: [] } };

        function mean(arr) { if (!arr.length) return 0; let s = 0; for (let i = 0; i < arr.length; i++) s += arr[i]; return s / arr.length; }
        function std(arr) { if (arr.length < 2) return 0; const m = mean(arr); let v = 0; for (let i = 0; i < arr.length; i++) { const d = arr[i] - m; v += d * d; } v /= (arr.length - 1); return Math.sqrt(v); }
        function pushStillnessSample(accel, gyro) { ['x', 'y', 'z'].forEach(k => { stillBuf.accel[k].push(accel[k]); if (stillBuf.accel[k].length > STILL_WINDOW_N) stillBuf.accel[k].shift(); stillBuf.gyro[k].push(gyro[k] * GYRO_MULTIPLIER); if (stillBuf.gyro[k].length > STILL_WINDOW_N) stillBuf.gyro[k].shift(); }); }

        let offsets = { accel: { x: 0, y: 0, z: 9.81 }, gyro: { x: 0, y: 0, z: 0 } };

        let lastImpactTime = 0;
        let impactHistory = [];
        let cli = 0.0;
        let currentNRS = 0.0;
        let currentAWE = 0.0;
        let latestISS = 0.0;
        const CLI_DECAY = 0.99;
        const AWE_DECAY_RATE = 0.4;
        let lastGyro = 0;

        const WHISE_THRESHOLD = 0.05;
        const MIN_LINEAR_G = 1;
        const MIN_ROTATIONAL_RAD_S2 = 75;
        const DEAD_TIME_MS = 3000;

        const AUTO_ZERO_ENABLED = true;
        const STILLNESS_WINDOW_MS = 600;
        const AUTO_ZERO_HOLD_MS = 0;
        const AUTO_ZERO_COOLDOWN_MS = 250;
        const AUTO_ZERO_MIN_UPTIME_MS = 100;
        const IMPACT_SUPPRESSION_MS = 0;
        const OMEGA_STD_THRESH = 0.12;
        const ACCEL_STD_THRESH = 0.25;
        const STILL_WINDOW_N = Math.max(5, Math.round(STILLNESS_WINDOW_MS * dataPointsPerSecond / 1000));

        let connectedAt = 0;
        let lastAutoZeroTime = 0;
        let stillStart = 0;

        function updateConnectionStatus(status) {
            const icon = connectButton.querySelector('.status-icon');
            const text = connectButton.querySelector('.status-text');
            switch (status) {
                case 'connected':
                    connectButton.className = 'connection-button status-connected';
                    icon.textContent = 'üü¢'; text.textContent = 'Connected';
                    connectButton.title = 'Click to disconnect';
                    isConnected = true; addSessionMarker('connect');
                    break;
                case 'connecting':
                    connectButton.className = 'connection-button status-connecting';
                    icon.textContent = 'üîµ'; text.textContent = 'Connecting...';
                    connectButton.disabled = true; isConnected = false;
                    break;
                case 'disconnected':
                default:
                    connectButton.className = 'connection-button status-disconnected';
                    icon.textContent = '‚ö™'; text.textContent = 'Disconnected';
                    connectButton.title = 'Click to connect';
                    connectButton.disabled = false; isConnected = false;
                    if (connectedAt > 0) { addSessionMarker('disconnect'); }
                    break;
            }
        }
        function addSessionMarker(type) {
            const now = Date.now();
            const timeStr = new Date(now).toLocaleTimeString();
            [accelChart, gyroChart].forEach(chart => {
                chart.data.labels.push(timeStr);
                chart.data.datasets.forEach(ds => ds.data.push(null));
                chart.$times.push(now);
            });
            if (type === 'pause' || type === 'resume') {
                nrsChart.data.labels.push(timeStr);
                nrsChart.data.datasets[0].data.push(null);
            }
        }
        function togglePause() {
            if (!isConnected) return;
            const icon = pauseButton.querySelector('.pause-icon');
            const text = pauseButton.querySelector('.pause-text');
            if (isPaused) {
                instantZeroSensors(); isPaused = false;
                pauseButton.className = 'pause-button pause-inactive';
                icon.textContent = '‚è∏Ô∏è'; text.textContent = 'Pause';
                addSessionMarker('resume');
            } else {
                isPaused = true;
                pauseButton.className = 'pause-button pause-active';
                icon.textContent = '‚ñ∂Ô∏è'; text.textContent = 'Resume';
                addSessionMarker('pause');
            }
        }
        function instantZeroSensors() {
            if (latestSensorData && latestSensorData.sensor) {
                const sd = latestSensorData.sensor;
                offsets.accel = { x: sd.accel.x, y: sd.accel.y, z: sd.accel.z };
                offsets.gyro = { x: sd.gyro.x, y: sd.gyro.y, z: sd.gyro.z };
            }
        }
        function sensorIsAccelStill(buf) { if (buf.accel.x.length < STILL_WINDOW_N) return false; return Math.max(std(buf.accel.x), std(buf.accel.y), std(buf.accel.z)) < ACCEL_STD_THRESH; }
        function sensorIsGyroStill(buf) { if (buf.gyro.x.length < STILL_WINDOW_N) return false; return Math.max(std(buf.gyro.x), std(buf.gyro.y), std(buf.gyro.z)) < OMEGA_STD_THRESH; }
        function applyAutoZeroForSensor(kind) { if (kind === 'accel') { offsets.accel = { x: mean(stillBuf.accel.x), y: mean(stillBuf.accel.y), z: mean(stillBuf.accel.z) }; } else if (kind === 'gyro') { offsets.gyro = { x: mean(stillBuf.gyro.x), y: mean(stillBuf.gyro.y), z: mean(stillBuf.gyro.z) }; } }
        function checkAutoZero() {
            if (!AUTO_ZERO_ENABLED || isPaused) return;
            const now = Date.now();
            if (connectedAt && now - connectedAt < AUTO_ZERO_MIN_UPTIME_MS) return;
            if (now - lastImpactTime < IMPACT_SUPPRESSION_MS) return;
            const accelStill = sensorIsAccelStill(stillBuf);
            const gyroStill = sensorIsGyroStill(stillBuf);
            if (!(accelStill || gyroStill)) { stillStart = 0; return; }
            if (!stillStart) stillStart = now;
            if (now - stillStart < STILLNESS_WINDOW_MS + AUTO_ZERO_HOLD_MS) return;
            if (now - lastAutoZeroTime < AUTO_ZERO_COOLDOWN_MS) return;
            if (accelStill) applyAutoZeroForSensor('accel');
            if (gyroStill) applyAutoZeroForSensor('gyro');
            lastAutoZeroTime = now;
            stillStart = 0;
        }

        const LOCAL_STORAGE_KEY = 'headImpactHistory';
        const NRS_STATE_KEY = 'nrsState';
        function saveImpactHistory() { try { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(impactHistory)); localStorage.setItem(NRS_STATE_KEY, JSON.stringify({ lastUpdate: Date.now(), currentNRS, currentAWE, cli, latestISS })); } catch (e) { console.error("Failed to save history:", e); } }
        function loadImpactHistory() { try { const stored = localStorage.getItem(LOCAL_STORAGE_KEY); const nrsState = localStorage.getItem(NRS_STATE_KEY); if (stored) { impactHistory = JSON.parse(stored); if (nrsState) { const state = JSON.parse(nrsState); cli = state.cli || 0; latestISS = state.latestISS || 0; } rebuildNRSChart(); recalculateRiskScores(); } } catch (e) { console.error("Failed to load history:", e); impactHistory = []; } }
        function clearImpactHistory() { impactHistory = []; currentNRS = 0.0; currentAWE = 0.0; latestISS = 0.0; cli = 0.0; localStorage.removeItem(LOCAL_STORAGE_KEY); localStorage.removeItem(NRS_STATE_KEY); rebuildNRSChart(); resetRiskScores(); showCustomAlert("Impact history cleared."); }
        function rebuildNRSChart() {
            nrsChart.data.labels = [];
            nrsChart.data.datasets[0].data = [];
            impactHistory.forEach(impact => { if (typeof impact.nrs === 'number') { nrsChart.data.labels.push(new Date(impact.time).toLocaleTimeString()); nrsChart.data.datasets[0].data.push(impact.nrs); } });
            if (nrsChart.data.labels.length > NRS_VISIBLE_POINTS) { const e = nrsChart.data.labels.length - NRS_VISIBLE_POINTS; nrsChart.data.labels.splice(0, e); nrsChart.data.datasets[0].data.splice(0, e); }
            nrsChart.update('none');
        }
        function recalculateRiskScores() {
            if (impactHistory.length === 0) { resetRiskScores(); return; }
            const now = Date.now();
            const oneDay = 86400000;
            impactHistory = impactHistory.filter(imp => (now - imp.time) < 7 * oneDay);
            let awe = 0;
            impactHistory.forEach(imp => { const daysAgo = (now - imp.time) / oneDay; awe += imp.iss * Math.exp(-AWE_DECAY_RATE * daysAgo); });
            currentAWE = awe;
            if (impactHistory.length > 0) {
                const latestImpact = impactHistory[impactHistory.length - 1];
                latestISS = latestImpact.iss;
                const nrs = 0.5 * latestImpact.iss + 0.3 * awe + 0.2 * cli;
                currentNRS = Math.round(nrs * 10) / 10;
                nrsScoreEl.textContent = currentNRS.toFixed(1);
                aweScoreEl.textContent = awe.toFixed(2);
                cliScoreEl.textContent = cli.toFixed(2);
                updateRiskLevel(currentNRS);
                latestImpact.nrs = currentNRS;
                latestImpact.awe = awe;
                latestImpact.cli = cli;
            } else {
                resetRiskScores();
            }
        }
        function updateRiskLevel(nrs) {
            if (nrs < 3) { nrsLevelEl.className = 'risk-level risk-low'; nrsLevelEl.textContent = 'Low Risk'; }
            else if (nrs < 6) { nrsLevelEl.className = 'risk-level risk-moderate'; nrsLevelEl.textContent = 'Moderate'; }
            else if (nrs < 8) { nrsLevelEl.className = 'risk-level risk-high'; nrsLevelEl.textContent = 'High - Evaluate'; }
            else { nrsLevelEl.className = 'risk-level risk-severe'; nrsLevelEl.textContent = 'Severe - Stop'; }
        }
        function resetRiskScores() { nrsScoreEl.textContent = "0.0"; nrsLevelEl.className = 'risk-level risk-low'; nrsLevelEl.textContent = 'Low Risk'; aweScoreEl.textContent = "0.0"; cliScoreEl.textContent = "0.0"; currentNRS = 0.0; currentAWE = 0.0; latestISS = 0.0; }

        const nrsChart = new Chart(document.getElementById('nrsChartCanvas').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'NRS', data: [], borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)', borderWidth: 2, fill: true, tension: 0.2, pointRadius: 0, spanGaps: false }] }, options: { responsive: true, maintainAspectRatio: false, animation: { duration: 0 }, plugins: { zoom: { zoom: { wheel: { enabled: true, speed: 0.005 }, pinch: { enabled: true }, mode: 'xy' }, pan: { enabled: true, mode: 'xy', speed: 0.0025 } }, legend: { labels: { color: '#e0e0e0', font: { size: 12 } } }, tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(30, 30, 30, 0.9)', titleColor: '#ffffff', bodyColor: '#e0e0e0' } }, scales: { x: { title: { display: true, text: 'Time', color: '#a0a0a0' }, ticks: { color: '#e0e0e0', maxTicksLimit: 8, autoSkip: true }, grid: { color: 'rgba(255,255,255,0.1)' } }, y: { min: 0, max: 10, title: { display: true, text: 'NRS', color: '#a0a0a0' }, ticks: { color: '#e0e0e0', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.1)' } } }, elements: { point: { radius: 0 } } } });
        function updateNRSRealtime() { const now = Date.now(); let awe = 0; impactHistory.forEach(imp => { const daysAgo = (now - imp.time) / 86400000; awe += imp.iss * Math.exp(-AWE_DECAY_RATE * daysAgo); }); currentAWE = awe; const nrs = 0.5 * latestISS + 0.3 * awe + 0.2 * cli; currentNRS = Math.max(0, nrs); nrsScoreEl.textContent = currentNRS.toFixed(1); aweScoreEl.textContent = awe.toFixed(2); updateRiskLevel(currentNRS); nrsChart.data.labels.push(new Date(now).toLocaleTimeString()); nrsChart.data.datasets[0].data.push(currentNRS); if (nrsChart.data.labels.length > NRS_VISIBLE_POINTS) { nrsChart.data.labels.shift(); nrsChart.data.datasets[0].data.shift(); } nrsChart.update('none'); lastNRSUpdate = now; saveImpactHistory(); }
        function startNRSUpdateInterval() { if (nrsUpdateInterval) clearInterval(nrsUpdateInterval); nrsUpdateInterval = setInterval(updateNRSRealtime, NRS_UPDATE_INTERVAL); }
        startNRSUpdateInterval();

        const RENDER_FPS = 60; const chartBuffers = new Map();
        function createChart(ctx, labelPrefix, yAxisLabel) { const chart = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [ { label: `${labelPrefix} X`, borderColor: 'rgb(239, 68, 68)', data: [], tension: 0.1, pointRadius: 0 }, { label: `${labelPrefix} Y`, borderColor: 'rgb(59, 130, 246)', data: [], tension: 0.1, pointRadius: 0 }, { label: `${labelPrefix} Z`, borderColor: 'rgb(16, 185, 129)', data: [], tension: 0.1, pointRadius: 0 } ] }, options: { responsive: true, maintainAspectRatio: false, animation: false, interaction: { mode: 'index', intersect: false }, plugins: { zoom: { zoom: { wheel: { enabled: true, speed: 0.005 }, pinch: { enabled: true }, mode: 'y' }, pan: { enabled: true, mode: 'x', speed: 0.0025 } }, legend: { labels: { usePointStyle: true, boxWidth: 8, padding: 16, color: '#e0e0e0' } }, tooltip: { callbacks: { title: (items) => { const t = items[0].chart.$times?.[items[0].dataIndex]; return t ? `Time: ${new Date(t).toLocaleTimeString()}` : ''; } } } }, scales: { x: { title: { display: true, text: 'Time', color: '#a0a0a0' }, ticks: { display: false }, grid: { display: false } }, y: { title: { display: true, text: yAxisLabel, color: '#a0e0e0' }, min: -MIN_Y_RANGE, max: MIN_Y_RANGE, ticks: { stepSize: 1, color: '#e0e0e0', callback: v => parseFloat(v.toFixed(1)) }, grid: { color: ctx => ctx.tick.value === 0 ? 'rgba(255,255,255,0.7)' : 'rgba(255,255,255,0.1)', lineWidth: ctx => ctx.tick.value === 0 ? 2 : 1 } } }, elements: { point: { radius: 0 } } } }); chart.$times = []; return chart; }
        const accelChart = createChart(document.getElementById('accelChartCanvas').getContext('2d'), 'Accel', 'm/s¬≤');
        const gyroChart = createChart(document.getElementById('gyroChartCanvas').getContext('2d'), 'Gyro', 'rad/s');
        chartBuffers.set(accelChart, { x: [], y: [], z: [], labels: [], times: [] });
        chartBuffers.set(gyroChart, { x: [], y: [], z: [], labels: [], times: [] });

        function setupChartInteractions() { const charts = [ { canvas: document.getElementById('nrsChartCanvas'), chart: nrsChart, type: 'nrs' }, { canvas: document.getElementById('accelChartCanvas'), chart: accelChart, type: 'accel' }, { canvas: document.getElementById('gyroChartCanvas'), chart: gyroChart, type: 'gyro' } ]; charts.forEach(({ canvas, chart, type }) => { let holdTimeout, isHolding = false, isDragging = false; canvas.addEventListener('mousedown', () => { isHolding = false; isDragging = false; holdTimeout = setTimeout(() => { if (!isDragging) { isHolding = true; chart.resetZoom(); canvas.style.opacity = '0.7'; setTimeout(() => { canvas.style.opacity = '1'; }, 200); } }, 500); }); canvas.addEventListener('mousemove', () => { if (!isHolding) { isDragging = true; clearTimeout(holdTimeout); } }); canvas.addEventListener('mouseup', () => { clearTimeout(holdTimeout); isDragging = false; }); canvas.addEventListener('mouseleave', () => { clearTimeout(holdTimeout); isDragging = false; }); canvas.addEventListener('dblclick', e => { e.preventDefault(); openFullscreen(type); }); canvas.addEventListener('touchstart', () => { isHolding = false; holdTimeout = setTimeout(() => { isHolding = true; chart.resetZoom(); canvas.style.opacity = '0.7'; setTimeout(() => { canvas.style.opacity = '1'; }, 200); }, 500); }); canvas.addEventListener('touchend', () => clearTimeout(holdTimeout)); canvas.addEventListener('contextmenu', e => e.preventDefault()); }); }
        function openFullscreen(type) { const modal = document.getElementById('fullscreen-modal'); const title = document.getElementById('fullscreen-title'); const canvas = document.getElementById('fullscreenChartCanvas'); currentFullscreenType = type; if (fullscreenChart) fullscreenChart.destroy(); let sourceChart; if (type === 'nrs') { sourceChart = nrsChart; title.textContent = 'Neurological Risk Score (NRS)'; } else if (type === 'accel') { sourceChart = accelChart; title.textContent = 'Accelerometer Data'; } else if (type === 'gyro') { sourceChart = gyroChart; title.textContent = 'Gyroscope Data'; } fullscreenChart = new Chart(canvas.getContext('2d'), { type: sourceChart.config.type, data: JSON.parse(JSON.stringify(sourceChart.data)), options: { ...sourceChart.config.options, plugins: { ...sourceChart.config.options.plugins, zoom: { limits: { y: { min: -100, max: 100 } }, zoom: { wheel: { enabled: true, speed: 0.005 }, pinch: { enabled: true }, mode: 'xy' }, pan: { enabled: true, mode: 'xy', speed: 0.0025, modifierKey: null } } }, elements: { point: { radius: 0 } } } }); if (sourceChart.$times) fullscreenChart.$times = [...sourceChart.$times]; modal.style.display = 'block'; if (type !== 'nrs') startFullscreenUpdate(sourceChart); }
        function closeFullscreen() { document.getElementById('fullscreen-modal').style.display = 'none'; if (fullscreenChart) { fullscreenChart.destroy(); fullscreenChart = null; } stopFullscreenUpdate(); }
        function resetZoom() { if (fullscreenChart) fullscreenChart.resetZoom(); }
        let fullscreenUpdateInterval = null;
        function startFullscreenUpdate(sourceChart) { stopFullscreenUpdate(); fullscreenUpdateInterval = setInterval(() => { if (fullscreenChart && sourceChart) { fullscreenChart.data = JSON.parse(JSON.stringify(sourceChart.data)); if (sourceChart.$times) fullscreenChart.$times = [...sourceChart.$times]; fullscreenChart.update('none'); } }, 100); }
        function stopFullscreenUpdate() { if (fullscreenUpdateInterval) { clearInterval(fullscreenUpdateInterval); fullscreenUpdateInterval = null; } }

        function scheduleChartPoint(chart, timeMs, x, y, z) { const b = chartBuffers.get(chart); b.x.push(x); b.y.push(y); b.z.push(z); b.labels.push(''); b.times.push(timeMs); }
        function commitChart(chart, buf) { if (buf.x.length === 0) return; const ds = chart.data.datasets; ds[0].data.push(...buf.x); ds[1].data.push(...buf.y); ds[2].data.push(...buf.z); chart.data.labels.push(...buf.labels); chart.$times.push(...buf.times); const over = chart.data.labels.length - VISIBLE_DATA_POINTS; if (over > 0) { ds.forEach(d => d.data.splice(0, over)); chart.data.labels.splice(0, over); chart.$times.splice(0, over); } let maxAbs = 0; const len = ds[0].data.length; for (let i = 0; i < len; i++) { if (ds[0].data[i] !== null) maxAbs = Math.max(maxAbs, Math.abs(ds[0].data[i]), Math.abs(ds[1].data[i]), Math.abs(ds[2].data[i])); } const desired = Math.max(maxAbs * (1 + Y_BUFFER_PERCENTAGE), MIN_Y_RANGE); const roundedDesired = Math.ceil(desired * 10) / 10; if (Math.abs(chart.options.scales.y.max - roundedDesired) > 0.1) { chart.options.scales.y.min = -roundedDesired; chart.options.scales.y.max = roundedDesired; } chart.update('none'); buf.x.length = buf.y.length = buf.z.length = buf.labels.length = buf.times.length = 0; }
        let lastFrame = 0; function rafCommit(t) { if (t - lastFrame >= (1000 / RENDER_FPS)) { for (const [chart, buf] of chartBuffers.entries()) commitChart(chart, buf); lastFrame = t; } requestAnimationFrame(rafCommit); } requestAnimationFrame(rafCommit);

        function smoothData(rawData, historyBuffer) { ['x', 'y', 'z'].forEach(axis => { historyBuffer[axis].push(rawData[axis]); if (historyBuffer[axis].length > SMOOTHING_WINDOW_SIZE) { historyBuffer[axis].shift(); } }); const avg = arr => arr.reduce((a, b) => a + b, 0) / arr.length; return { x: avg(historyBuffer.x), y: avg(historyBuffer.y), z: avg(historyBuffer.z) }; }
        function detectImpact(a, g) { if (impactDetectionDisabled || isPaused) return; const now = Date.now(); if (now - lastImpactTime < DEAD_TIME_MS) return; const a_mag_mss = Math.sqrt(a.x ** 2 + a.y ** 2 + a.z ** 2); const a_mag_g = a_mag_mss / 9.81; const g_multiplied = { x: g.x * GYRO_MULTIPLIER, y: g.y * GYRO_MULTIPLIER, z: g.z * GYRO_MULTIPLIER }; const omega_mag = Math.sqrt(g_multiplied.x ** 2 + g_multiplied.y ** 2 + g_multiplied.z ** 2); const alpha_mag = (omega_mag - (lastGyro || 0)) / 0.01; lastGyro = omega_mag; if (a_mag_g < MIN_LINEAR_G) return; if (Math.abs(alpha_mag) < MIN_ROTATIONAL_RAD_S2) return; const whise = 0.4 * (a_mag_g / 100) + 0.6 * (Math.abs(alpha_mag) / 6000); if (whise >= WHISE_THRESHOLD) { lastImpactTime = now; const iss = Math.log10(1 + a_mag_g) * (1 + Math.abs(alpha_mag) / 5000) * 1.3; const impact = { time: now, a_peak: a_mag_g, alpha_peak: Math.abs(alpha_mag), iss: parseFloat(iss.toFixed(2)) }; impactHistory.push(impact); saveImpactHistory(); processImpact(impact); } }

        function onDisconnected() { updateConnectionStatus('disconnected'); pauseButton.classList.add('hidden'); impactDetectionDisabled = true; isPaused = false; }
        async function connectToBle() { try { updateConnectionStatus('connecting'); if (!navigator.bluetooth) throw new Error("Web Bluetooth not supported."); bleDevice = await navigator.bluetooth.requestDevice({ filters: [{ name: DEVICE_NAME }], optionalServices: [SERVICE_UUID] }); bleDevice.addEventListener('gattserverdisconnected', onDisconnected); const server = await bleDevice.gatt.connect(); const service = await server.getPrimaryService(SERVICE_UUID); bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID); await bleCharacteristic.startNotifications(); bleCharacteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueChanged); updateConnectionStatus('connected'); pauseButton.classList.remove('hidden'); connectedAt = Date.now(); impactDetectionDisabled = true; setTimeout(() => { instantZeroSensors(); impactDetectionDisabled = false; }, 500); } catch (error) { console.error("BLE Connection error:", error); updateConnectionStatus('disconnected'); if (error.name === 'NotFoundError') { showCustomAlert("No device selected."); } else { showCustomAlert("BLE Error: " + error.message); } } }
        async function disconnectBle() { if (bleDevice && bleDevice.gatt.connected) await bleDevice.gatt.disconnect(); }
        
        connectButton.addEventListener('click', async () => { const status = connectButton.querySelector('.status-text').textContent; if (status === 'Connected') await disconnectBle(); else if (status === 'Disconnected') await connectToBle(); });
        pauseButton.addEventListener('click', togglePause);
        clearHistoryButton.addEventListener('click', clearImpactHistory);
        helpButton.addEventListener('click', () => { document.getElementById('shortcuts-modal').style.display = 'block'; });

        document.addEventListener('keydown', e => { if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return; switch (e.key.toLowerCase()) { case 'escape': document.getElementById('alert-modal').style.display = 'none'; document.getElementById('shortcuts-modal').style.display = 'none'; if (fullscreenChart) closeFullscreen(); break; case 'c': if (!e.ctrlKey && !e.metaKey) connectButton.click(); break; case 'p': if (!e.ctrlKey && !e.metaKey && isConnected) togglePause(); break; case 'delete': clearHistoryButton.click(); break; case 'd': if (!e.ctrlKey && !e.metaKey) document.querySelector('details').open = !document.querySelector('details').open; break; case '?': if (e.shiftKey) document.getElementById('shortcuts-modal').style.display = 'block'; break; } });
        window.onclick = e => { if (e.target.className === 'modal') e.target.style.display = 'none'; };
        window.addEventListener('DOMContentLoaded', () => { setupChartInteractions(); });
        window.addEventListener('load', () => { loadImpactHistory(); });
        
        function handleCharacteristicValueChanged(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            const receivedString = decoder.decode(value);
            liveFeed.textContent = receivedString;
            liveFeed.scrollTop = liveFeed.scrollHeight;
            try {
                latestSensorData = JSON.parse(receivedString);
                if (isPaused || !latestSensorData.sensor) return;
                
                const smoothedA = smoothData(latestSensorData.sensor.accel, accelHistory);
                const smoothedG = smoothData(latestSensorData.sensor.gyro, gyroHistory);
                const zeroedA = { x: smoothedA.x - offsets.accel.x, y: smoothedA.y - offsets.accel.y, z: smoothedA.z - offsets.accel.z };
                const zeroedG = { x: (smoothedG.x - offsets.gyro.x) * GYRO_MULTIPLIER, y: (smoothedG.y - offsets.gyro.y) * GYRO_MULTIPLIER, z: (smoothedG.z - offsets.gyro.z) * GYRO_MULTIPLIER };
                
                latestDisplay.a = zeroedA;
                latestDisplay.g = zeroedG;
                pushStillnessSample(smoothedA, smoothedG);
                detectImpact(zeroedA, zeroedG);

                if (performance.now() - lastDomFlush >= (1000 / DOM_FPS)) {
                    accelXEl.textContent = zeroedA.x.toFixed(2); accelYEl.textContent = zeroedA.y.toFixed(2); accelZEl.textContent = zeroedA.z.toFixed(2);
                    gyroXEl.textContent = zeroedG.x.toFixed(2); gyroYEl.textContent = zeroedG.y.toFixed(2); gyroZEl.textContent = zeroedG.z.toFixed(2);
                    lastDomFlush = performance.now();
                }

                const nowMs = Date.now();
                scheduleChartPoint(accelChart, nowMs, zeroedA.x, zeroedA.y, zeroedA.z);
                scheduleChartPoint(gyroChart, nowMs, zeroedG.x, zeroedG.y, zeroedG.z);
                checkAutoZero();
            } catch (e) { console.error("Error in handler:", e); }
        }

        function processImpact(impact) {
            cli = CLI_DECAY * cli + (1 - CLI_DECAY) * impact.iss;
            const now = Date.now();
            let awe = 0;
            impactHistory.forEach(imp => {
                const daysAgo = (now - imp.time) / 86400000;
                awe += imp.iss * Math.exp(-AWE_DECAY_RATE * daysAgo);
            });
            currentAWE = awe;
            latestISS = impact.iss;
            const nrs = 0.5 * impact.iss + 0.3 * awe + 0.2 * cli;
            const nrsRounded = Math.round(nrs * 10) / 10;
            currentNRS = nrsRounded;

            impact.nrs = nrsRounded;
            impact.awe = awe;
            impact.cli = cli;

            nrsScoreEl.textContent = nrsRounded.toFixed(1);
            aweScoreEl.textContent = awe.toFixed(2);
            cliScoreEl.textContent = cli.toFixed(2);
            updateRiskLevel(nrsRounded);

            // Restore non-AI alert for significant impacts
            if (nrsRounded >= 8) {
                showCustomAlert(`SEVERE IMPACT!\nNRS: ${nrsRounded}\nISS: ${impact.iss.toFixed(2)}\nAccel: ${impact.a_peak.toFixed(1)}g\nRotation: ${impact.alpha_peak.toFixed(0)} rad/s¬≤\n\nImmediate evaluation recommended.`);
            } else if (nrsRounded >= 6) {
                showCustomAlert(`High Risk Detected!\nNRS: ${nrsRounded}\nISS: ${impact.iss.toFixed(2)}\nAccel: ${impact.a_peak.toFixed(1)}g\nRotation: ${impact.alpha_peak.toFixed(0)} rad/s¬≤\n\nPlease monitor for symptoms.`);
            }
            
            updateNRSRealtime();
            startNRSUpdateInterval();
        }

    </script>
</body>
</html>