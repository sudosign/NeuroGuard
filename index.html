<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 MPU6050 BLE Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #121212; 
            color: #e0e0e0; 
        }
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.7); 
            backdrop-filter: blur(5px); 
        }
        .modal-content { 
            background-color: #1f1f1f; 
            margin: 15% auto; 
            padding: 24px; 
            border-radius: 12px; 
            box-shadow: 0 10px 15px rgba(0,0,0,0.3); 
            max-width: 500px; 
            animation: fadeIn 0.3s ease-in-out; 
            color: #e0e0e0; 
        }
        .close-button { 
            color: #888; 
            float: right; 
            font-size: 28px; 
            font-weight: bold; 
        }
        .close-button:hover, .close-button:focus { 
            color: #ccc; 
            text-decoration: none; 
            cursor: pointer; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(-20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .live-feed-box { 
            background-color: #2c2c2c; 
            color: #a0a0a0; 
            font-family: 'Courier New', Courier, monospace; 
            height: 200px; 
            overflow-y: scroll; 
        }
        .hidden { 
            display: none; 
        }
        .data-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }
        @media (max-width: 1280px) {
            .data-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 768px) {
            .data-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col items-center p-4 sm:p-8">
    <div class="max-w-6xl w-full flex flex-col gap-6">
        <h1 class="text-3xl font-bold text-center text-gray-100 mb-4">MPU6050 BLE Sensor Viewer</h1>
        <p id="status-message" class="text-center text-sm text-gray-400">
            Please connect to your ESP32 device to start receiving data.
        </p>
        <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="connectButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                Connect to ESP32
            </button>
            <button id="zeroButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 transform hover:scale-105 hidden">
                Zero Sensors
            </button>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <div class="bg-gray-800 p-6 rounded-xl shadow-xl">
                <h2 class="text-lg font-semibold text-gray-200 mb-4">Accelerometer Live Graph (Average)</h2>
                <div class="relative h-80">
                    <canvas id="accelChartCanvas"></canvas>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-xl shadow-xl">
                <h2 class="text-lg font-semibold text-gray-200 mb-4">Gyroscope Live Graph (Average)</h2>
                <div class="relative h-80">
                    <canvas id="gyroChartCanvas"></canvas>
                </div>
            </div>
        </div>

        <details class="bg-gray-800 p-6 rounded-xl shadow-xl">
            <summary class="text-lg font-semibold text-gray-200 cursor-pointer select-none">
                Debug Information
            </summary>
            <div class="mt-4 flex flex-col gap-6">
                <div id="data-container" class="data-grid">
                    <div class="bg-gray-700 p-6 rounded-xl shadow-inner">
                        <h2 class="text-lg font-semibold text-gray-200 mb-2">Sensor 1</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h3 class="text-md font-semibold text-gray-400">Accelerometer (m/s²)</h3>
                                <div class="space-y-1 text-gray-300 font-medium text-sm">
                                    <p>X: <span id="s1_accelX" class="font-mono text-gray-100">--</span></p>
                                    <p>Y: <span id="s1_accelY" class="font-mono text-gray-100">--</span></p>
                                    <p>Z: <span id="s1_accelZ" class="font-mono text-gray-100">--</span></p>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-md font-semibold text-gray-400">Gyroscope (rad/s)</h3>
                                <div class="space-y-1 text-gray-300 font-medium text-sm">
                                    <p>X: <span id="s1_gyroX" class="font-mono text-gray-100">--</span></p>
                                    <p>Y: <span id="s1_gyroY" class="font-mono text-gray-100">--</span></p>
                                    <p>Z: <span id="s1_gyroZ" class="font-mono text-gray-100">--</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-700 p-6 rounded-xl shadow-inner">
                        <h2 class="text-lg font-semibold text-gray-200 mb-2">Sensor 2</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h3 class="text-md font-semibold text-gray-400">Accelerometer (m/s²)</h3>
                                <div class="space-y-1 text-gray-300 font-medium text-sm">
                                    <p>X: <span id="s2_accelX" class="font-mono text-gray-100">--</span></p>
                                    <p>Y: <span id="s2_accelY" class="font-mono text-gray-100">--</span></p>
                                    <p>Z: <span id="s2_accelZ" class="font-mono text-gray-100">--</span></p>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-md font-semibold text-gray-400">Gyroscope (rad/s)</h3>
                                <div class="space-y-1 text-gray-300 font-medium text-sm">
                                    <p>X: <span id="s2_gyroX" class="font-mono text-gray-100">--</span></p>
                                    <p>Y: <span id="s2_gyroY" class="font-mono text-gray-100">--</span></p>
                                    <p>Z: <span id="s2_gyroZ" class="font-mono text-gray-100">--</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-700 p-6 rounded-xl shadow-inner">
                        <h2 class="text-lg font-semibold text-gray-200 mb-2">Sensor 3</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h3 class="text-md font-semibold text-gray-400">Accelerometer (m/s²)</h3>
                                <div class="space-y-1 text-gray-300 font-medium text-sm">
                                    <p>X: <span id="s3_accelX" class="font-mono text-gray-100">--</span></p>
                                    <p>Y: <span id="s3_accelY" class="font-mono text-gray-100">--</span></p>
                                    <p>Z: <span id="s3_accelZ" class="font-mono text-gray-100">--</span></p>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-md font-semibold text-gray-400">Gyroscope (rad/s)</h3>
                                <div class="space-y-1 text-gray-300 font-medium text-sm">
                                    <p>X: <span id="s3_gyroX" class="font-mono text-gray-100">--</span></p>
                                    <p>Y: <span id="s3_gyroY" class="font-mono text-gray-100">--</span></p>
                                    <p>Z: <span id="s3_gyroZ" class="font-mono text-gray-100">--</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-700 p-6 rounded-xl shadow-inner">
                        <h2 class="text-lg font-semibold text-gray-200 mb-2">Sensor 4</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h3 class="text-md font-semibold text-gray-400">Accelerometer (m/s²)</h3>
                                <div class="space-y-1 text-gray-300 font-medium text-sm">
                                    <p>X: <span id="s4_accelX" class="font-mono text-gray-100">--</span></p>
                                    <p>Y: <span id="s4_accelY" class="font-mono text-gray-100">--</span></p>
                                    <p>Z: <span id="s4_accelZ" class="font-mono text-gray-100">--</span></p>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-md font-semibold text-gray-400">Gyroscope (rad/s)</h3>
                                <div class="space-y-1 text-gray-300 font-medium text-sm">
                                    <p>X: <span id="s4_gyroX" class="font-mono text-gray-100">--</span></p>
                                    <p>Y: <span id="s4_gyroY" class="font-mono text-gray-100">--</span></p>
                                    <p>Z: <span id="s4_gyroZ" class="font-mono text-gray-100">--</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-700 p-6 rounded-xl shadow-xl">
                    <h2 class="text-lg font-semibold text-gray-200 mb-2">Live Data Feed (JSON)</h2>
                    <pre id="live-feed" class="live-feed-box p-4 rounded-xl text-xs overflow-auto"></pre>
                </div>
            </div>
        </details>
        
        <div id="alert-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="document.getElementById('alert-modal').style.display='none'">&times;</span>
                <h3 class="text-xl font-bold mb-2">Information</h3>
                <p id="alert-message" class="text-gray-300 whitespace-pre-line"></p>
            </div>
        </div>
    </div>
    <script>
        // --- Custom Alert Function ---
        function showCustomAlert(message) {
            const modal = document.getElementById('alert-modal');
            const alertMessage = document.getElementById('alert-message');
            alertMessage.textContent = message;
            modal.style.display = 'block';
        }

        // --- BLE UUIDs and Device Name ---
        const SERVICE_UUID = "12345678-1234-1234-1234-123456789abc";
        const CHARACTERISTIC_UUID = "87654321-4321-4321-4321-cba987654321";
        const DEVICE_NAME = "ESP32_MPU6050_BLE";

        // --- DOM Elements ---
        const connectButton = document.getElementById('connectButton');
        const zeroButton = document.getElementById('zeroButton');
        const statusMessage = document.getElementById('status-message');
        const liveFeed = document.getElementById('live-feed');

        // Dynamically get DOM elements for all sensors
        const sensorDisplays = {};
        for (let i = 1; i <= 4; i++) {
            sensorDisplays[`s${i}`] = {
                accel: {
                    x: document.getElementById(`s${i}_accelX`),
                    y: document.getElementById(`s${i}_accelY`),
                    z: document.getElementById(`s${i}_accelZ`)
                },
                gyro: {
                    x: document.getElementById(`s${i}_gyroX`),
                    y: document.getElementById(`s${i}_gyroY`),
                    z: document.getElementById(`s${i}_gyroZ`)
                }
            };
        }

        // --- Global BLE Objects ---
        let bleDevice;
        let bleCharacteristic;

        // --- Data Processing Constants and Variables ---
        const SMOOTHING_WINDOW_SIZE = 7;
        const VISIBLE_DATA_POINTS = 500;
        const dataPointsPerSecond = 100;
        const maxTimeInSeconds = VISIBLE_DATA_POINTS / dataPointsPerSecond;
        const Y_BUFFER_PERCENTAGE = 0.05;
        const MIN_Y_RANGE = 3;
        
        let accelHistory = { s1: { x: [], y: [], z: [] }, s2: { x: [], y: [], z: [] }, s3: { x: [], y: [], z: [] }, s4: { x: [], y: [], z: [] } };
        let gyroHistory = { s1: { x: [], y: [], z: [] }, s2: { x: [], y: [], z: [] }, s3: { x: [], y: [], z: [] }, s4: { x: [], y: [], z: [] } };

        // --- Sensor Offsets (Accelerometer and Gyroscope) ---
        let offsets = {
            s1: { accel: { x: 0, y: 0, z: 9.81 }, gyro: { x: 0, y: 0, z: 0 } },
            s2: { accel: { x: 0, y: 0, z: 9.81 }, gyro: { x: 0, y: 0, z: 0 } },
            s3: { accel: { x: 0, y: 0, z: 9.81 }, gyro: { x: 0, y: 0, z: 0 } },
            s4: { accel: { x: 0, y: 0, z: 9.81 }, gyro: { x: 0, y: 0, z: 0 } }
        };

        // --- Data Smoothing and Calculation ---
        function smoothData(rawData, historyBuffer) {
            historyBuffer.x.push(rawData.x);
            historyBuffer.y.push(rawData.y);
            historyBuffer.z.push(rawData.z);
            if (historyBuffer.x.length > SMOOTHING_WINDOW_SIZE) {
                historyBuffer.x.shift();
                historyBuffer.y.shift();
                historyBuffer.z.shift();
            }
            const sum = (arr) => arr.reduce((a, b) => a + b, 0);
            const avg = (arr) => arr.length > 0 ? sum(arr) / arr.length : 0;
            return {
                x: avg(historyBuffer.x),
                y: avg(historyBuffer.y),
                z: avg(historyBuffer.z)
            };
        }
        
        // --- Chart.js Setup (Refactored for clarity) ---
        function createChart(ctx, labelPrefix, yAxisLabel) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: `${labelPrefix} X`,
                        data: [],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.2)',
                        tension: 0.4,
                    }, {
                        label: `${labelPrefix} Y`,
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        tension: 0.4,
                    }, {
                        label: `${labelPrefix} Z`,
                        data: [],
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        tension: 0.4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { 
                            labels: { 
                                usePointStyle: true, 
                                boxWidth: 8, 
                                padding: 16, 
                                color: '#e0e0e0' 
                            } 
                        },
                        tooltip: { 
                            callbacks: { 
                                title: (tooltipItems) => `Time: ${tooltipItems[0].label}`
                            } 
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: `Time`, color: '#a0a0a0' }, 
                            ticks: {
                                maxTicksLimit: 10,
                                color: '#e0e0e0',
                                // This callback function only shows a label at 30-second intervals
                                callback: function(value, index, ticks) {
                                    if (index % (dataPointsPerSecond * 30) === 0) {
                                        return this.getLabelForValue(value);
                                    }
                                    return '';
                                },
                                font: function(context) {
                                    if (context.tick && context.tick.label && context.tick.label.includes(':30')) {
                                        return { weight: 'bold' };
                                    }
                                    return { weight: 'normal' };
                                }
                            },
                            grid: { display: true, color: 'rgba(255, 255, 255, 0.1)' } 
                        },
                        y: {
                            title: { display: true, text: yAxisLabel, color: '#a0e0e0' },
                            min: -MIN_Y_RANGE,
                            max: MIN_Y_RANGE,
                            ticks: { stepSize: 1, color: '#e0e0e0' },
                            grid: {
                                color: (context) => context.tick.value === 0 ? 'rgba(255, 255, 255, 0.7)' : 'rgba(255, 255, 255, 0.1)',
                                lineWidth: (context) => context.tick.value === 0 ? 2 : 1
                            }
                        }
                    },
                    elements: { point: { radius: 0 } }
                }
            });
        }

        const accelChart = createChart(document.getElementById('accelChartCanvas').getContext('2d'), 'Accel (Avg)', 'Value (m/s²)');
        const gyroChart = createChart(document.getElementById('gyroChartCanvas').getContext('2d'), 'Gyro (Avg)', 'Value (rad/s)');

        // --- Offset Calculation Logic ---
        const ZEROING_SAMPLES = 25;
        let zeroingSampleCount = 0;
        let zeroingSamples = {
            s1: { accel: { x: [], y: [], z: [] }, gyro: { x: [], y: [], z: [] } },
            s2: { accel: { x: [], y: [], z: [] }, gyro: { x: [], y: [], z: [] } },
            s3: { accel: { x: [], y: [], z: [] }, gyro: { x: [], y: [], z: [] } },
            s4: { accel: { x: [], y: [], z: [] }, gyro: { x: [], y: [], z: [] } }
        };
        let isZeroing = false;

        function startZeroing() {
            if (isZeroing) return;
            isZeroing = true;
            zeroingSampleCount = 0;
            zeroingSamples = {
                s1: { accel: { x: [], y: [], z: [] }, gyro: { x: [], y: [], z: [] } },
                s2: { accel: { x: [], y: [], z: [] }, gyro: { x: [], y: [], z: [] } },
                s3: { accel: { x: [], y: [], z: [] }, gyro: { x: [], y: [], z: [] } },
                s4: { accel: { x: [], y: [], z: [] }, gyro: { x: [], y: [], z: [] } }
            };
            zeroButton.disabled = true;
            zeroButton.textContent = 'Zeroing...';
            statusMessage.textContent = 'Zeroing sensors... Please keep the device flat and still for 5 seconds.';
        }

        function calculateNewOffsets(sensorData) {
            if (!isZeroing) return;

            for (let i = 1; i <= 4; i++) {
                const sensorKey = `sensor${i}`;
                const samplesKey = `s${i}`;
                
                zeroingSamples[samplesKey].accel.x.push(sensorData[sensorKey].accel.x);
                zeroingSamples[samplesKey].accel.y.push(sensorData[sensorKey].accel.y);
                zeroingSamples[samplesKey].accel.z.push(sensorData[sensorKey].accel.z);
                zeroingSamples[samplesKey].gyro.x.push(sensorData[sensorKey].gyro.x);
                zeroingSamples[samplesKey].gyro.y.push(sensorData[sensorKey].gyro.y);
                zeroingSamples[samplesKey].gyro.z.push(sensorData[sensorKey].gyro.z);
            }
            zeroingSampleCount++;

            statusMessage.textContent = `Zeroing sensors... Sample ${zeroingSampleCount}/${ZEROING_SAMPLES}`;

            if (zeroingSampleCount >= ZEROING_SAMPLES) {
                isZeroing = false;
                zeroButton.disabled = false;
                zeroButton.textContent = 'Zero Sensors';
                statusMessage.textContent = 'Sensor zeroing complete. New offsets applied.';
                
                const sum = (arr) => arr.reduce((a, b) => a + b, 0);
                const avg = (arr) => arr.length > 0 ? sum(arr) / arr.length : 0;
                
                for (let i = 1; i <= 4; i++) {
                    const samplesKey = `s${i}`;
                    const sensorOffsets = offsets[samplesKey];
                    const sensorSamples = zeroingSamples[samplesKey];
                    
                    sensorOffsets.accel.x = avg(sensorSamples.accel.x);
                    sensorOffsets.accel.y = avg(sensorSamples.accel.y);
                    sensorOffsets.accel.z = avg(sensorSamples.accel.z);
                    sensorOffsets.gyro.x = avg(sensorSamples.gyro.x);
                    sensorOffsets.gyro.y = avg(sensorSamples.gyro.y);
                    sensorOffsets.gyro.z = avg(sensorSamples.gyro.z);
                }

                zeroingSampleCount = 0;
                zeroingSamples = {
                    s1: { accel: { x: [], y: [], z: [] }, gyro: { x: [], y: [], z: [] } },
                    s2: { accel: { x: [], y: [], z: [] }, gyro: { x: [], y: [], z: [] } },
                    s3: { accel: { x: [], y: [], z: [] }, gyro: { x: [], y: [], z: [] } },
                    s4: { accel: { x: [], y: [], z: [] }, gyro: { x: [], y: [], z: [] } }
                };
            }
        }

        // --- Main Data Handling Function ---
        function handleCharacteristicValueChanged(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            const receivedString = decoder.decode(value);
            liveFeed.textContent = receivedString;
            liveFeed.scrollTop = liveFeed.scrollHeight;

            try {
                const sensorData = JSON.parse(receivedString);

                // If zeroing is in progress, collect samples and calculate new offsets
                if (isZeroing) {
                    calculateNewOffsets(sensorData);
                }

                // Calculate average of all sensors for the graph
                const accelAvg = { x: 0, y: 0, z: 0 };
                const gyroAvg = { x: 0, y: 0, z: 0 };

                for (let i = 1; i <= 4; i++) {
                    const sensorKey = `sensor${i}`;
                    const samplesKey = `s${i}`;
                    const rawAccel = sensorData[sensorKey].accel;
                    const rawGyro = sensorData[sensorKey].gyro;
                    
                    // Apply smoothing to each sensor individually
                    const smoothedAccel = smoothData(rawAccel, accelHistory[samplesKey]);
                    const smoothedGyro = smoothData(rawGyro, gyroHistory[samplesKey]);

                    // Apply the offsets to each sensor's smoothed data
                    const zeroedAccel = {
                        x: smoothedAccel.x - offsets[samplesKey].accel.x,
                        y: smoothedAccel.y - offsets[samplesKey].accel.y,
                        z: smoothedAccel.z - offsets[samplesKey].accel.z
                    };
                    
                    const zeroedGyro = {
                        x: smoothedGyro.x - offsets[samplesKey].gyro.x,
                        y: smoothedGyro.y - offsets[samplesKey].gyro.y,
                        z: smoothedGyro.z - offsets[samplesKey].gyro.z
                    };

                    // Update the displayed values for each sensor
                    sensorDisplays[samplesKey].accel.x.textContent = zeroedAccel.x.toFixed(2);
                    sensorDisplays[samplesKey].accel.y.textContent = zeroedAccel.y.toFixed(2);
                    sensorDisplays[samplesKey].accel.z.textContent = zeroedAccel.z.toFixed(2);
                    sensorDisplays[samplesKey].gyro.x.textContent = zeroedGyro.x.toFixed(2);
                    sensorDisplays[samplesKey].gyro.y.textContent = zeroedGyro.y.toFixed(2);
                    sensorDisplays[samplesKey].gyro.z.textContent = zeroedGyro.z.toFixed(2);

                    // Add to the average for the charts
                    accelAvg.x += zeroedAccel.x;
                    accelAvg.y += zeroedAccel.y;
                    accelAvg.z += zeroedAccel.z;
                    gyroAvg.x += zeroedGyro.x;
                    gyroAvg.y += zeroedGyro.y;
                    gyroAvg.z += zeroedGyro.z;
                }

                if (!isZeroing) {
                    statusMessage.textContent = 'Receiving live data...';
                }

                // --- Update Charts with the averaged data ---
                function updateChart(chartInstance, dataX, dataY, dataZ) {
                    chartInstance.data.datasets[0].data.push(dataX);
                    chartInstance.data.datasets[1].data.push(dataY);
                    chartInstance.data.datasets[2].data.push(dataZ);
                    
                    // Get the current time for the x-axis label
                    const now = new Date();
                    chartInstance.data.labels.push(now.toLocaleTimeString());

                    // Dynamic Y-axis Scaling
                    const allData = [...chartInstance.data.datasets[0].data, ...chartInstance.data.datasets[1].data, ...chartInstance.data.datasets[2].data];
                    const maxY = Math.max(...allData.map(Math.abs));
                    const chartMaxY = Math.max(maxY * (1 + Y_BUFFER_PERCENTAGE), MIN_Y_RANGE);
                    chartInstance.options.scales.y.min = -chartMaxY;
                    chartInstance.options.scales.y.max = chartMaxY;

                    // Manage Data Points
                    if (chartInstance.data.datasets[0].data.length > VISIBLE_DATA_POINTS) {
                        const pointsToRemove = chartInstance.data.datasets[0].data.length - VISIBLE_DATA_POINTS;
                        chartInstance.data.datasets.forEach(dataset => dataset.data.splice(0, pointsToRemove));
                        chartInstance.data.labels.splice(0, pointsToRemove);
                    }
                    
                    chartInstance.update('none');
                }

                updateChart(accelChart, accelAvg.x / 4, accelAvg.y / 4, accelAvg.z / 4);
                updateChart(gyroChart, gyroAvg.x / 4, gyroAvg.y / 4, gyroAvg.z / 4);
                
            } catch (error) {
                console.error("Error parsing JSON:", error);
                showCustomAlert("Error parsing sensor data. Received: " + receivedString);
            }
        }

        // --- BLE Connection and Disconnection ---
        function onDisconnected(event) {
            console.log('Device disconnected:', event.target.name);
            statusMessage.textContent = 'Disconnected. Click connect to try again.';
            connectButton.textContent = 'Connect to ESP32';
            connectButton.disabled = false;
            connectButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            connectButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            zeroButton.classList.add('hidden');
            isZeroing = false;
            zeroButton.disabled = false;
            zeroButton.textContent = 'Zero Sensors';
        }

        async function connectToBle() {
            try {
                connectButton.textContent = 'Connecting...';
                connectButton.disabled = true;
                statusMessage.textContent = 'Requesting BLE device...';

                if (!navigator.bluetooth) {
                    throw new Error("Web Bluetooth is not supported by this browser. Please use Chrome, Edge, or a similar browser.");
                }

                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: DEVICE_NAME }],
                    optionalServices: [SERVICE_UUID]
                });

                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
                statusMessage.textContent = 'Connecting to GATT server...';
                const server = await bleDevice.gatt.connect();
                statusMessage.textContent = 'Getting primary service...';
                const service = await server.getPrimaryService(SERVICE_UUID);
                statusMessage.textContent = 'Getting characteristic...';
                bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                statusMessage.textContent = 'Starting notifications...';
                await bleCharacteristic.startNotifications();
                bleCharacteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueChanged);

                statusMessage.textContent = 'Successfully connected and receiving data.';
                connectButton.textContent = 'Connected';
                connectButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                connectButton.classList.add('bg-green-600', 'hover:bg-green-700');
                zeroButton.classList.remove('hidden');

            } catch (error) {
                console.error("Bluetooth connection failed:", error);
                let errorMessage = "An unknown error occurred.";
                if (error.name === "NotFoundError") {
                    errorMessage = "No matching device found. Make sure your ESP32 is powered on and advertising.";
                } else if (error.name === "NetworkError") {
                    errorMessage = "Network connection failed. Your BLE device might be out of range.";
                } else if (error.message) {
                    errorMessage = error.message;
                }
                showCustomAlert("Connection Error: " + errorMessage);
                connectButton.textContent = 'Connect to ESP32';
                connectButton.disabled = false;
                statusMessage.textContent = 'Connection failed. Please try again.';
                connectButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                connectButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                zeroButton.classList.add('hidden');
            }
        }

        // --- Assign event listeners ---
        connectButton.addEventListener('click', connectToBle);
        zeroButton.addEventListener('click', startZeroing);

        // --- Close custom alert when clicking outside ---
        window.onclick = function(event) {
            const modal = document.getElementById('alert-modal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>